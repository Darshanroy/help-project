{% extends "layout.html" %}
{% block title %}Yield Prediction - Harvest Helper{% endblock %}
{% block content %}
<div class="form-wrapper">
    <div class="form-container shadow-lg">
        <h2 class="text-center mb-4">Crop Yield Prediction</h2>
        <p class="text-center text-muted mb-4">Enter the following details to predict crop production.</p>
        <form id="yieldForm">
            <div class="mb-3">
                <label for="Area" class="form-label">Area (in hectares)</label>
                <input type="number" step="0.01" class="form-control" id="Area" name="Area" placeholder="e.g., 1000" required>
            </div>
            
            <div class="mb-3">
                <label for="State_Name" class="form-label">State Name</label>
                <select class="form-select" id="State_Name" name="State_Name" required>
                    <option value="">Select State</option>
                    {% for state in states %}
                        <option value="{{ state }}">{{ state }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- --- NEW: District Dropdown (initially disabled) --- -->
            <div class="mb-3">
                <label for="District_Name" class="form-label">District Name</label>
                <select class="form-select" id="District_Name" name="District_Name" required disabled>
                    <option value="">Select a state first</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="Season" class="form-label">Season</label>
                <select class="form-select" id="Season" name="Season" required>
                    <option value="">Select Season</option>
                    {% for season in seasons %}
                        <option value="{{ season }}">{{ season }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="Crop" class="form-label">Crop</label>
                <select class="form-select" id="Crop" name="Crop" required>
                    <option value="">Select Crop</option>
                    {% for crop in crops %}
                        <option value="{{ crop }}">{{ crop }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg">Predict Yield</button>
            </div>
        </form>
        <div id="yieldResult" class="mt-4 text-center">
            <!-- Animation and result will be displayed here -->
        </div>
        <div class="text-center mt-3">
            <a href="/" class="btn btn-secondary">Back to Home</a>
        </div>
    </div>
</div>

<script>
    // --- NEW JAVASCRIPT for dynamic dropdowns ---
    document.getElementById('State_Name').addEventListener('change', function () {
        const selectedState = this.value;
        const districtSelect = document.getElementById('District_Name');
        
        // Clear and disable district dropdown
        districtSelect.innerHTML = '<option value="">Loading...</option>';
        districtSelect.disabled = true;

        if (selectedState) {
            fetch(`/get_districts/${selectedState}`)
                .then(response => response.json())
                .then(data => {
                    districtSelect.innerHTML = '<option value="">Select District</option>';
                    data.districts.forEach(function (district) {
                        const option = document.createElement('option');
                        option.value = district;
                        option.textContent = district;
                        districtSelect.appendChild(option);
                    });
                    districtSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Error fetching districts:', error);
                    districtSelect.innerHTML = '<option value="">Could not load districts</option>';
                });
        } else {
            // Reset if no state is selected
            districtSelect.innerHTML = '<option value="">Select a state first</option>';
            districtSelect.disabled = true;
        }
    });


    // --- Existing JavaScript for form submission ---
    document.getElementById('yieldForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const resultDiv = document.getElementById('yieldResult');
        resultDiv.innerHTML = `<div class="spinner-container"><div class="spinner-border text-success" role="status"><span class="visually-hidden">Calculating yield...</span></div><p class="mt-2">Predicting crop yield...</p></div>`;
        
        const formData = new FormData(this);
        fetch('/predict_yield', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.prediction !== undefined && data.prediction !== null) {
                resultDiv.innerHTML = `<div class="alert alert-success fade-in"><h4>Predicted Production:</h4><p class="display-6 fw-bold">${data.prediction} Units</p><p class="text-muted small">Units typically refer to tonnes or units as defined in the dataset.</p></div>`;
            } else {
                 resultDiv.innerHTML = `<div class="alert alert-danger fade-in"><h4>Error:</h4><p>${data.error || 'An unknown error occurred.'}</p></div>`;
            }
        })
        .catch(error => {
            resultDiv.innerHTML = `<div class="alert alert-danger fade-in"><h4>An error occurred:</h4><p>${error}</p></div>`;
        });
    });
</script>
{% endblock %}